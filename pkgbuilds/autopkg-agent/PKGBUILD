# Maintainer: Ephreal

pkgname="autopkg-agent"
pkgver="0.2.0"
pkgrel=1
pkgdesc="Automatically build and store packages for archlinux"
arch=("x86_64")
url="https://gitlab.needs.management/ephreal/autopkg-agent"
install="$pkgname.install"
license=('MIT')
makedepends=('rust')
source=("${url}/-/archive/${pkgver}/${pkgname}-${pkgver}.zip")
sha256sums=('e560c14fb2dc63568d0d1574b2f60fc47085735fdea72b373a2a2b4997f3364e')

backup=(
    "etc/autopkg/autopkg-agent.json"
)

prepare() {
    echo "$pkgname-$pkgver"
    cd "$pkgname-$pkgver"
    cargo build --release
}

package() {
    cd "$pkgname-$pkgver"
    mkdir -p "$pkgdir/usr/bin"
    mkdir -p "$pkgdir/etc/autopkg"
    mkdir -p "$pkgdir/etc/systemd/system"

    cp target/release/$pkgname $pkgdir/usr/bin
    cp src/autopkg-agent-example.json $pkgdir/etc/autopkg/autopkg-agent.json

    echo "[Unit] 
Description=Autopkg Agent Service
Wants=network-online.target
After=network.target network-online.target

[Service]
Type=simple
Restart=on-failure
RestartSec=10
User=autopkg
WorkingDirectory=/usr/bin
ExecStart=/usr/bin/autopkg-agent

[Install]
WantedBy=multi-user.target" >> $pkgdir/etc/systemd/system/autopkg-agent.service
}
